!function(a,b,c,d){function e(b,c){return this.element=b,this.$element=a(b),this.options=a.extend({},g,c),this._defaults=g,this._name=f,this._zoom=5,this._layerCount=0,this._highestLayer=1,this.init(),5!=this.options.zoom&&this.setZoom(this.options.zoom),this}var f="multiTimeline",g={start:moment().subtract(7,"days").format("YYYY-MM-DD"),end:moment().add(7,"days").format("YYYY-MM-DD"),xAxisDateFormat:"DD/MM",markerDateFormat:"YYYY-MM-DD HH:mm",timelineSpacing:30,zoomStep:1,zoom:5,maxLabelCount:20,infinity:"9999-12-31",dawn:"0000-01-01",data:[],mousewheelPan:!0,mousewheelZoom:!0,allDraggable:!0,allResizeable:!0,gridPrecision:15,onTimelineClick:function(){},onZoomChange:function(){},onDragEnd:function(){},onResizeEnd:function(){},onEdit:function(){},zoomInControl:null,zoomOutControl:null,goLeftControl:null,goRightControl:null};e.prototype={init:function(){return null===this.options.start||null===this.options.end?(console.error("multi-timeline.js: start or end date is missing!"),!1):(this._startMoment=moment(this.options.start),this._endMoment=moment(this.options.end),this._endMoment.isAfter(this._startMoment)?(this._secondsCount=this.getDuration(this._startMoment,this._endMoment),this._daysCount=this._secondsCount/60/60/24,this._percentagePerDay=100/(this._daysCount+1),this._timelineCount=this.options.data.length,void this.createStructure().addTimelines().addEventHandlers().setWrapperDimensions().setReady()):(console.error("multi-timline.js: end date has to be a date after start date!"),!1))},setReady:function(){return this.$element.addClass("is-ready"),this},createStructure:function(){return this.$element.addClass("tl-wrapper"),this.addMarks(),this},addMarks:function(){for(var b=this._startMoment,c=this._endMoment.add(1,"day"),d=a('<ul class="tl-time">'),e=-1,f="";!b.isSame(c);){e++,b=b.add(1,"day"),f=b,this._daysCount>10&&e%Math.round(this._daysCount/this.options.maxLabelCount)!==0&&(f="");var g=b.isSame(new Date,"day");this.addTimeUnit(d,f,e+1,g)}d.appendTo(this.$element)},addTimeUnit:function(b,c,d,e){moment.isMoment(c)&&(c=c.format(this.options.xAxisDateFormat));var f=a('<li class="tl-time__unit">').html(c).css({left:d*this._percentagePerDay+"%"}).append("<span>");e&&f.addClass("is-today"),f.appendTo(b)},getDuration:function(a,b){var c=moment.duration(b.diff(a));return c.asSeconds()},addTimelines:function(){var b=this,c=0;return a(this.options.data).each(function(e){var f,g={past:!1,future:!1},h=this;(h.end==d||h.start==b.options.infinity)&&(g.end=!0,h.end=b.options.infinity),(h.start==d||h.start==b.options.dawn)&&(g.start=!0,h.start=b.options.dawn);var i,j=b.getDuration(moment(h.start),moment(h.end)),k=j/60/60/24,l=b.getDuration(moment(b.options.start),moment(h.start)),m=l/60/60/24;h.layer===d?(i=c,c++,b.options.data[e].layer=i):i=h.layer;var n="",o="";0>l&&(j+=l,k=j/60/60/24,m=l=0,n="tl-overflow-left");var p=k*b._percentagePerDay;m+k>b._daysCount+1&&(o="tl-overflow-right",p=100);var q=m*b._percentagePerDay;m>b._daysCount+1&&(q=100);var r=0>j?"hidden":"visible";h.title=h.title!==d?h.title:"&nbsp;";var s=a('<div class="tl-timeline">').html(b.getTimelineHtml(h)).css({width:p+"%",left:q+"%",visibility:r,bottom:i*b.options.timelineSpacing+20+"px","background-color":h.color!==d?h.color:null,"z-index":h.zIndex!==d?h.zIndex:10}).addClass(n+" "+o+" "+(h["class"]!==d?h["class"]:"")).attr({"data-tl-start-offset":l,"data-tl-duration":j,"data-tl-identifier":e,"data-tl-layer":i,title:h.title}).on("click",function(a){b.options.onTimelineClick(a,h)}).on("mouseenter",function(){clearTimeout(f),a(this).addClass("is-hovered")}).on("mouseleave",function(){var b=a(this);b.hasClass("is-dragging")||(f=setTimeout(function(){b.removeClass("is-hovered")},100))});(b.options.allDraggable===!0||h.draggable===!0)&&s.addClass("is-draggable"),(b.options.allResizeable===!0||h.resizeable===!0)&&s.addClass("is-resizeable"),g.start===!0&&s.addClass("is-infinite-start"),g.end===!0&&s.addClass("is-infinite-end"),s.prependTo(b.$element),parseInt(s.outerWidth())<140&&s.find(".tl-timeline__date-end").remove()}),this._layerCount=c,this},getTimelineHtml:function(a){var b="";return b+='<div class="tl-timeline__resizer tl-timeline__resizer-start"></div>',b+='<div class="tl-timeline__resizer tl-timeline__resizer-end"></div>',a.start!=this.options.dawn&&this.options.markerDateFormat!==!1&&(b+='<div class="tl-timeline__date-marker tl-timeline__date-start">',b+=moment(a.start).format(this.options.markerDateFormat),b+="</div>"),b+='<div class="tl-timeline__title">'+a.title+"</div>",a.end!=this.options.infinity&&this.options.markerDateFormat!==!1&&(b+='<div class="tl-timeline__date-marker tl-timeline__date-end">',b+=moment(a.end).format(this.options.markerDateFormat),b+="</div>"),b},setWrapperDimensions:function(){var b=this,c=0,d=this.$element.outerWidth();this.$element.find(".tl-timeline").each(function(){var e=100/d*parseInt(a(this).css("left"));if(e>0&&100>e){var f=a(this).data("tl-layer");f>b._highestLayer&&(b._highestLayer=f),0===c&&(b.timelineHeight=parseInt(a(this).outerHeight()))}});var e=c+(this._highestLayer+2)*this.options.timelineSpacing;return e+=5,this.$element.css("height",e).find(".tl-time__unit span").css({height:e,top:-1*e}),this},addEventHandlers:function(){var d=this;null!==this.options.zoomInControl&&this.options.zoomInControl.on("click",function(a){d.zoomIn(),a.preventDefault()}),null!==this.options.zoomOutControl&&this.options.zoomOutControl.on("click",function(a){d.zoomOut(),a.preventDefault()}),null!==this.options.goRightControl&&this.options.goRightControl.on("click",function(a){d.goRight(),a.preventDefault()}),null!==this.options.goLeftControl&&this.options.goLeftControl.on("click",function(a){d.goLeft(),a.preventDefault()}),(this.options.mousewheelPan===!0||this.options.mousewheelZoom===!0)&&this.$element.on("mousewheel DOMMouseScroll onmousewheel",function(a){var a=b.event||a,c=Math.max(-1,Math.min(1,a.wheelDelta||-a.detail));a.ctrlKey===!0&&d.options.mousewheelZoom===!0?c>0?d.zoomIn():d.zoomOut():d.options.mousewheelPan===!0&&(c>0?d.goLeft():d.goRight()),a.preventDefault()});var e={x:0,y:0},f={x:0,y:0,isDragging:!1};return d.$element.on("mousedown",".tl-timeline",function(b){var g=!1;if(a(this).hasClass("is-draggable")&&(g="move"),a(this).hasClass("is-resizeable")&&(a(b.target).hasClass("tl-timeline__resizer-start")||a(this).hasClass("is-infinite-end")?g="w-resize":(a(b.target).hasClass("tl-timeline__resizer-end")||a(this).hasClass("is-infinite-start"))&&(g="e-resize")),g!==!1&&!f.isDragging){f.isDragging=!0;var h=a(this);a("body").css("cursor",g),d.$element.find(".tl-timeline").css("z-index",1e3),h.css({"z-index":1050,cursor:g}).addClass("is-hovered is-dragging");var i,j={x:b.pageX,y:b.pageY};f.x=b.pageX,f.y=b.pageY;var k=a(this).parents();k.on("mousemove",function(a){e.x=a.pageX-f.x,e.y=a.pageY-f.y;var b=parseInt(h.data("tl-layer"));if(i=j.y-a.pageY,i>d.options.timelineSpacing)h.css("bottom",(b+1)*d.options.timelineSpacing+20+"px"),h.data("tl-layer",b+1),j.y=a.pageY,d.setWrapperDimensions();else if(i<-1*d.options.timelineSpacing){var c=b-1;0>c&&(c=0,b=1),h.css("bottom",c*d.options.timelineSpacing+20+"px"),h.data("tl-layer",b-1),j.y=a.pageY,d.setWrapperDimensions()}d.options.data[h.data("tl-identifier")].layer=b;var k=h.offset(),l=k.left+e.x,m=parseFloat(h.css("width"));switch(g){case"move":h.offset({left:l});break;case"w-resize":if(m-e.x<50)return;h.offset({left:l}).css("width",m-e.x);break;case"e-resize":if(m+e.x<50)return;h.css("width",m+e.x)}var n=parseInt(h.css("left")),o=100/parseInt(d.$element.innerWidth())*n;d.updateDates(h,d.percentToDate(o)),f.x=a.pageX,f.y=a.pageY}),a(c).on("mouseup",function(){if(f.isDragging){f.isDragging=!1;var b=parseInt(h.css("left")),e=100/parseInt(d.$element.innerWidth())*b;a("body").css("cursor","default"),h.css({left:e+"%",cursor:"default"}).removeClass("is-dragging is-hovered"),"move"==g?d.options.onDragEnd(h,d):d.options.onResizeEnd(h,d),d.options.onEdit(h,d),k.off("mousemove"),a(c).off("mouseup"),d._highestLayer=1,d.setWrapperDimensions()}}),b.preventDefault()}}),this},updateDates:function(a,b){a.hasClass("is-infinite-start")&&(b=moment(this.options.dawn));var c=parseInt(a.css("left")),d=100/parseInt(this.$element.innerWidth())*(c+a.outerWidth()),e=a.hasClass("is-infinite-end")?moment(this.options.infinity):this.percentToDate(d);this.options.data[a.data("tl-identifier")].start=b.format("YYYY-MM-DD HH:mm:ss"),this.options.data[a.data("tl-identifier")].end=e.format("YYYY-MM-DD HH:mm:ss"),a.hasClass("is-infinite-start")&&delete this.options.data[a.data("tl-identifier")].start,a.hasClass("is-infinite-end")&&delete this.options.data[a.data("tl-identifier")].end,a.data("tl-duration",this.getDuration(b,e)),this.options.markerDateFormat!==!1&&a.find(".tl-timeline__date-start").html(b.format(this.options.markerDateFormat)),this.options.markerDateFormat!==!1&&a.find(".tl-timeline__date-end").html(e.format(this.options.markerDateFormat))},percentToDate:function(a){var b=(this._daysCount+1)/100,c=parseInt(a*b*24*60*60),d=moment(this.options.start).add(c,"seconds"),e=d.get("minute");return d.set("minute",Math.round(e/this.options.gridPrecision)*this.options.gridPrecision),d.set("second",0),d},removeEventHandlers:function(){return null!==this.options.zoomInControl&&this.options.zoomInControl.off("click"),null!==this.options.zoomOutControl&&this.options.zoomOutControl.off("click"),null!==this.options.goRightControl&&this.options.goRightControl.off("click"),null!==this.options.goLeftControl&&this.options.goLeftControl.off("click"),(this.options.mousewheelPan===!0||this.options.mousewheelZoom===!0)&&this.$element.off("mousewheel DOMMouseScroll onmousewheel"),this.$element.off("mousedown",".tl-timeline"),this},setZoom:function(a){if(!(0>a)){var b=this._zoom-a;b>0?this.zoomIn(b):0>b&&this.zoomOut(Math.abs(b))}},zoomOut:function(a){a===d&&(a=1),this.options.start=moment(this.options.start).subtract(a*this.options.zoomStep,"days").format("YYYY-MM-DD"),this.options.end=moment(this.options.end).add(a*this.options.zoomStep,"days").format("YYYY-MM-DD"),this._zoom=this._zoom+a,this.options.onZoomChange(this._zoom),this.redraw()},zoomIn:function(a){a===d&&(a=1);var b=moment(this.options.start).add(a*this.options.zoomStep,"days"),c=moment(this.options.end).subtract(a*this.options.zoomStep,"days");b.isBefore(c)&&(this.options.start=b.format("YYYY-MM-DD"),this.options.end=c.format("YYYY-MM-DD"),this._zoom=this._zoom-a,this.options.onZoomChange(this._zoom),this.redraw())},goRight:function(){var a=Math.ceil(this._daysCount/12);this.options.start=moment(this.options.start).add(a,"days").format("YYYY-MM-DD"),this.options.end=moment(this.options.end).add(a,"days").format("YYYY-MM-DD"),this.redraw()},goLeft:function(){var a=Math.ceil(this._daysCount/12);this.options.start=moment(this.options.start).subtract(a,"days").format("YYYY-MM-DD"),this.options.end=moment(this.options.end).subtract(a,"days").format("YYYY-MM-DD"),this.redraw()},reset:function(){return this.$element.html(""),this.removeEventHandlers(),this},redraw:function(){this.reset().init()},getData:function(){return this.options.data}},a.fn[f]=function(b){return this.each(function(){return a.data(this,f)||a.data(this,f,new e(this,b)),this})}}(jQuery,window,document);